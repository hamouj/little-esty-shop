require 'rails_helper'

describe 'As an admin', type: :feature do
  let!(:merchant1) { create(:merchant) }
  let!(:merchant2) { create(:merchant) }

  let!(:item1) { create(:item, merchant: merchant1) }  
  let!(:item2) { create(:item, merchant: merchant1) }
  let!(:item3) { create(:item, merchant: merchant1) }
  let!(:item4) { create(:item, merchant: merchant1) }
  let!(:item5) { create(:item, merchant: merchant1) }

  let!(:customer1) { create(:customer) }
  let!(:customer2) { create(:customer) }

  let!(:invoice1) { create(:invoice, created_at: Date.new(2020, 1, 2), customer: customer1) }
  let!(:invoice2) { create(:invoice, created_at: Date.new(2019, 3, 9), customer: customer2) }

  let!(:invoice_item1) { create(:invoice_item, invoice: invoice1, item: item1, quantity: 1) }
  let!(:invoice_item3) { create(:invoice_item, invoice: invoice1, item: item3, quantity: 3) }
  let!(:invoice_item4) { create(:invoice_item, invoice: invoice1, item: item4, quantity: 4) }
  let!(:invoice_item5) { create(:invoice_item, invoice: invoice1, item: item5, quantity: 5) }

  let!(:invoice_item2) { create(:invoice_item, invoice: invoice2, item: item2) }
  
  describe "When I visit an admin invoice show page" do
    it 'I see the invoice ID, status, and created_at date with formatting' do
      visit "/admin/invoices/#{invoice1.id}"

      expect(page).to have_content("Invoice ##{invoice1.id}")
      expect(page).to_not have_content("Invoice ##{invoice2.id}")
      expect(page).to have_select('Status', :selected=> "#{invoice1.status}")
      expect(page).to have_content("Created on: #{invoice1.created_at.strftime("%A, %B %d, %Y")}")
    end

    it "I see the customers first and last name" do
      visit "/admin/invoices/#{invoice1.id}"

      within "#customers" do
        expect(page).to have_content(customer1.first_name)
        expect(page).to have_content(customer1.last_name)
      end
    end

    it "I see all of the items on the invoice, including their name, quantity, price, and status" do
      visit "/admin/invoices/#{invoice1.id}"

      expect(page).to_not have_content(item2.name)

      within "##{item1.name}" do
        expect(page).to have_content(item1.name)
        expect(page).to have_content(invoice_item1.quantity)
        expect(page).to have_content("$#{invoice_item1.unit_price.to_f/100}")
        expect(page).to have_content(invoice_item1.status)
      end

      within "##{item3.name}" do
        expect(page).to have_content(item3.name)
        expect(page).to have_content(invoice_item3.quantity)
        expect(page).to have_content("$#{invoice_item3.unit_price.to_f/100}")
        expect(page).to have_content(invoice_item3.status)
      end

      within "##{item4.name}" do
        expect(page).to have_content(item4.name)
        expect(page).to have_content(invoice_item4.quantity)
        expect(page).to have_content("$#{invoice_item4.unit_price.to_f/100}")
        expect(page).to have_content(invoice_item4.status)
      end

      within "##{item5.name}" do
        expect(page).to have_content(item5.name)
        expect(page).to have_content(invoice_item5.quantity)
        expect(page).to have_content("$#{invoice_item5.unit_price.to_f/100}")
        expect(page).to have_content(invoice_item5.status)
      end
    end

    it "I see the invoice status is a select field and next to the select field I see a button to 'Update Invoice Status'" do
      visit "/admin/invoices/#{invoice1.id}"

      expect(page).to have_select('Status', :selected=> "#{invoice1.status}")
      expect(page).to have_button("Update Invoice Status")
    end

    it "When I select a new status for the Invoice and click the button, I am taken back to the admin invoice show page" do
      visit "/admin/invoices/#{invoice1.id}"

      select 'cancelled', from: :invoice_status
      click_button 'Update Invoice Status'

      expect(current_path).to eq(admin_invoice_path(invoice1))
    end

    it "When I select a new status and click the button, I see that my invoice's status has now been updated" do
      visit "/admin/invoices/#{invoice1.id}"

      select 'cancelled', from: :invoice_status
      click_button 'Update Invoice Status'

      expect(page).to have_select('Status', :selected=> "cancelled")
    end

    it "I see the total revenue that will be generated from this invoice" do
      total_revenue = (invoice_item1.unit_price * invoice_item1.quantity) + (invoice_item3.unit_price * invoice_item3.quantity) + (invoice_item4.unit_price * invoice_item4.quantity) + (invoice_item5.unit_price * invoice_item5.quantity)
      
      visit "/admin/invoices/#{invoice1.id}"

      within "#total_revenue" do
        expect(page).to have_content("$#{(total_revenue/100.0).round(2)}")
      end
    end

    it "I see the total discounted revenue from this invoice" do
      item6 = create(:item, merchant: merchant2)
      invoice_item6 = create(:invoice_item, invoice: invoice1, item: item6, quantity: 4)

      merchant1.bulk_discounts.create!(percent_discount: 10, quantity_threshold: 3)
      merchant1.bulk_discounts.create!(percent_discount: 15, quantity_threshold: 5)

      merchant2.bulk_discounts.create!(percent_discount: 10, quantity_threshold: 4)

      total_revenue = (invoice_item1.unit_price * invoice_item1.quantity) + (invoice_item3.unit_price * invoice_item3.quantity) + (invoice_item4.unit_price * invoice_item4.quantity) + (invoice_item5.unit_price * invoice_item5.quantity) + (invoice_item6.unit_price * invoice_item6.quantity)
      total_discount = (invoice_item3.unit_price * 0.10 * invoice_item3.quantity) +  (invoice_item4.unit_price * 0.10 * invoice_item4.quantity) + (invoice_item5.unit_price * 0.15 *invoice_item5.quantity) + (invoice_item6.unit_price * 0.10 * invoice_item6.quantity)
      discounted_revenue = total_revenue - total_discount
  
      visit "/admin/invoices/#{invoice1.id}"

      within "#discounted_revenue" do
        expect(page).to have_content("$#{(discounted_revenue/100.0).round(2)}")
      end
    end
  end
end